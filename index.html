<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StockSync</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Poppins', Arial, sans-serif;
            max-width: 900px;
            margin: 20px auto;
            padding: 15px;
            background-color: #f0f4ff;
            color: #4a5568;
            position: relative;
            padding-top: 60px;
            padding-bottom: 60px;
        }
        .container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        h1 {
            text-align: center;
            color: #2b6cb0;
            font-size: 2.2em;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            position: relative;
            z-index: 10;
        }
        h1 i {
            color: #2b6cb0;
        }
        .account-tab {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(to right, #4a90e2, #63b3ed);
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 4px 4px 0 0;
            cursor: pointer;
            font-size: 0.8em;
            font-weight: 600;
            transition: background 0.2s;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .account-tab:hover {
            background: linear-gradient(to right, #357abd, #4299e1);
        }
        .account-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background-color: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 0 0 4px 4px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            min-width: 150px;
            z-index: 1000;
        }
        .account-tab:hover .account-dropdown {
            display: block;
        }
        .account-dropdown button {
            display: block;
            width: 100%;
            padding: 8px;
            text-align: left;
            background: none;
            border: none;
            cursor: pointer;
            color: #2b6cb0;
            font-size: 0.9em;
        }
        .account-dropdown button:hover {
            background-color: #f0f4ff;
        }
        .card {
            background-color: #ffffff;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        }
        .input-section {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 10px;
        }
        .input-group {
            flex: 1 1 calc(50% - 7.5px);
            min-width: 0;
            display: flex;
            flex-direction: column;
        }
        label {
            font-weight: 600;
            color: #1a365d;
            font-size: 0.95em;
            margin-bottom: 5px;
        }
        .description {
            font-size: 0.75em;
            color: #718096;
            font-style: italic;
            margin-top: 3px;
        }
        input, select {
            padding: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.9em;
            background-color: #edf2f7;
            color: #2d3748;
            transition: border-color 0.3s ease;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #4a90e2;
        }
        input::placeholder {
            color: #a0aec0;
            opacity: 0.7;
        }
        button {
            background: linear-gradient(to right, #4a90e2, #63b3ed);
            color: white;
            padding: 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: background 0.2s;
            width: 100%;
        }
        button:hover {
            background: linear-gradient(to right, #357abd, #4299e1);
        }
        button:disabled {
            background: #a0aec0;
            cursor: not-allowed;
        }
        .results-section {
            margin-top: 15px;
            display: none;
        }
        .result-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .result-table th, .result-table td {
            border: 1px solid #e2e8f0;
            padding: 8px;
            text-align: center;
        }
        .result-table th {
            background-color: #f8fafc;
            color: #2b6cb0;
        }
        .chart-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
        }
        .chart {
            border: 1px solid #000;
            border-radius: 5px;
            background-color: #ffffff;
            width: 280px;
            height: 300px;
            position: relative;
            overflow: hidden;
            flex: 1 1 280px;
        }
        .chart .chart-title {
            font-size: 12px;
            font-weight: 600;
            color: #2b6cb0;
            text-align: center;
            padding: 3px 0;
            background-color: #f8fafc;
            border-bottom: 1px solid #000;
        }
        .chart svg {
            width: 100%;
            height: 270px;
            padding: 5px;
        }
        .chart legend {
            font-size: 9px;
            color: #4a5568;
            margin-top: 3px;
            text-align: center;
        }
        .error {
            color: #e53e3e;
            font-size: 0.9em;
            text-align: center;
            margin-top: 10px;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            width: 300px;
            text-align: center;
            position: relative;
        }
        .modal-content input, .modal-content select {
            width: 90%;
            margin: 10px 0;
        }
        .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.5em;
            cursor: pointer;
            color: #4a5568;
        }
        .close-btn:hover {
            color: #e53e3e;
        }
        .tab-buttons {
            display: flex;
            justify-content: space-around;
            margin-bottom: 15px;
        }
        .tab-buttons button {
            width: 45%;
            padding: 8px;
        }
        .chat-icon {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(to right, #4a90e2, #63b3ed);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: transform 0.2s;
        }
        .chat-icon:hover {
            transform: scale(1.1);
        }
        @media (max-width: 900px) {
            body { padding: 10px; max-width: 100%; padding-top: 50px; padding-bottom: 50px; }
            h1 { font-size: 1.8em; }
            .input-section { flex-direction: column; }
            .input-group { flex: 1 1 100%; }
            .card { padding: 10px; }
            button { padding: 8px; }
            .chart { width: 100%; height: 280px; }
            .chart .chart-title { font-size: 11px; }
            .chart svg { height: 250px; }
            .account-tab { top: 10px; right: 10px; padding: 4px 8px; font-size: 0.7em; }
            .account-dropdown { min-width: 120px; }
            .chat-icon { bottom: 10px; right: 10px; width: 40px; height: 40px; font-size: 1.2em; }
        }
    </style>
</head>
<body>
    <div class="account-tab">Account <i class="fas fa-caret-down"></i>
        <div class="account-dropdown">
            <button onclick="openModal('create')">Create Account</button>
            <button onclick="openModal('login')">Log In</button>
        </div>
    </div>
    <div class="container">
        <h1><i class="fas fa-sync-alt"></i> StockSync</h1>
        <div class="card">
            <h2>Data Input</h2>
            <div class="input-section">
                <div class="input-group">
                    <label for="uploadSales">Upload Sales Sheet</label>
                    <input type="file" id="uploadSales" accept=".csv">
                    <p class="description">CSV with: stock_id, product_name, sales_amount, sales_date (max 1000 records).</p>
                </div>
                <div class="input-group">
                    <label for="uploadPurchases">Upload Purchase Sheet</label>
                    <input type="file" id="uploadPurchases" accept=".csv">
                    <p class="description">CSV with: stock_id, product_name, purchase_amount, purchase_date (max 1000 records).</p>
                </div>
                <div class="input-group">
                    <label for="service_reliability">Service Reliability</label>
                    <select id="service_reliability">
                        <option value="1.65">Very High (95%)</option>
                        <option value="1.28" selected>High (90%)</option>
                        <option value="0.84">Moderate (80%)</option>
                    </select>
                    <p class="description">Select the desired service reliability level.</p>
                </div>
                <div class="input-group">
                    <label for="annual_operating_days">Annual Operating Days</label>
                    <input type="number" id="annual_operating_days" placeholder="e.g., 365" step="any">
                    <p class="description">Enter the number of days you operate annually.</p>
                </div>
            </div>
            <button onclick="calculate()">Analyze Inventory</button>
            <div id="results" class="results-section"></div>
            <div id="error" class="error"></div>
        </div>
        <div class="card">
            <h2>Example</h2>
            <div class="example">
                <p><strong>Sales CSV:</strong><br>stock_id,product_name,sales_amount,sales_date<br>S001,Widget A,5000,2025-06-01<br>S002,Widget B,5500,2025-06-15</p>
                <p><strong>Purchase CSV:</strong><br>stock_id,product_name,purchase_amount,purchase_date<br>S001,Widget A,4000,2025-06-01<br>S002,Widget B,4500,2025-06-15</p>
            </div>
        </div>
    </div>
    <div id="accountModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">×</span>
            <div class="tab-buttons">
                <button id="createTabBtn" onclick="showTab('create')">Create Account</button>
                <button id="loginTabBtn" onclick="showTab('login')">Log In</button>
            </div>
            <div id="create-tab">
                <h3>Create Account</h3>
                <input type="text" id="accountName" placeholder="Your Name" required>
                <input type="email" id="accountEmail" placeholder="Your Email" required>
                <input type="password" id="accountPassword" placeholder="Password" required>
                <button onclick="createAccount()">Submit</button>
            </div>
            <div id="login-tab" style="display: none;">
                <h3>Log In</h3>
                <input type="email" id="loginEmail" placeholder="Your Email" required>
                <input type="password" id="loginPassword" placeholder="Password" required>
                <button onclick="logIn()">Submit</button>
            </div>
        </div>
    </div>
    <div id="feedbackModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeFeedbackModal()">×</span>
            <h3>Feedback</h3>
            <form id="feedback-form">
                <div id="feedback-auth" style="display: none;">
                    <input type="text" id="feedbackName" placeholder="Your Name" required>
                    <input type="email" id="feedbackEmail" placeholder="Your Email" required>
                </div>
                <label>Which feature is most useful?</label>
                <select id="feedbackFeature">
                    <option value="Analyze Inventory">Analyze Inventory</option>
                    <option value="Export to PDF">Export to PDF</option>
                    <option value="Charts">Charts</option>
                </select>
                <label>What changes would make it more useful?</label>
                <select id="feedbackChange">
                    <option value="Faster Processing">Faster Processing</option>
                    <option value="Better UI">Better UI</option>
                    <option value="More Features">More Features</option>
                </select>
                <button type="button" onclick="submitFeedback()">Submit Feedback</button>
            </form>
        </div>
    </div>
    <button class="chat-icon" onclick="openFeedbackModal()"><i class="fas fa-comment"></i></button>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        let batchSize = 200;
        let isAuthenticated = false;

        function safetyStock(dailySales, leadTime, stdDev, zScore) {
            return zScore * stdDev * Math.sqrt(leadTime) || 0;
        }

        function reorderPoint(dailySales, leadTime, safetyStock) {
            return (dailySales * leadTime) + safetyStock || 0;
        }

        function optimalOrderSize(annualDemand, orderCost, holdTime) {
            return Math.sqrt((2 * annualDemand * orderCost) / holdTime) || 0;
        }

        function processCSVFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const text = e.target.result;
                    const rows = text.split('\n').map(row => row.split(',').map(cell => cell.trim()));
                    const headers = rows[0].map(h => h.toLowerCase());
                    let data = rows.slice(1).filter(row => row.length === headers.length && row.some(cell => cell !== ''));

                    if (data.length > 1000) {
                        reject(new Error('Upload limit exceeded. Maximum 1000 records allowed.'));
                        return;
                    }

                    data = data.map(row => {
                        const obj = {};
                        if (headers.includes('stock_id') && headers.includes('product_name')) {
                            obj['stock_id'] = row[headers.indexOf('stock_id')];
                            obj['product_name'] = row[headers.indexOf('product_name')];
                            if (headers.includes('sales_amount') && headers.includes('sales_date')) {
                                obj['sales_amount'] = parseFloat(row[headers.indexOf('sales_amount')]) || 0;
                                obj['sales_date'] = row[headers.indexOf('sales_date')];
                            }
                            if (headers.includes('purchase_amount') && headers.includes('purchase_date')) {
                                obj['purchase_amount'] = parseFloat(row[headers.indexOf('purchase_amount')]) || 0;
                                obj['purchase_date'] = row[headers.indexOf('purchase_date')];
                            }
                        }
                        return obj;
                    }).filter(obj => obj.stock_id && obj.product_name);
                    resolve(data);
                };
                reader.onerror = () => reject(new Error('Error reading file.'));
                reader.readAsText(file);
            });
        }

        async function preprocessData(salesData, purchaseData) {
            if (!salesData.length || !purchaseData.length) return null;

            const products = {};
            const salesDates = salesData.map(item => new Date(item.sales_date)).sort((a, b) => a - b);
            const daysActive = (salesDates[salesDates.length - 1] - salesDates[0]) / (1000 * 60 * 60 * 24) || 1;
            const annualOperatingDays = parseFloat(document.getElementById('annual_operating_days').value) || Math.min(365, daysActive);
            const serviceReliability = parseFloat(document.getElementById('service_reliability').value) || 1.28;

            for (let i = 0; i < salesData.length; i += batchSize) {
                const batch = salesData.slice(i, i + batchSize);
                batch.forEach(sale => {
                    if (sale.stock_id && sale.product_name) {
                        if (!products[sale.stock_id]) {
                            products[sale.stock_id] = { name: sale.product_name, sales: [], purchases: [] };
                        }
                        if (sale.sales_amount !== undefined) {
                            products[sale.stock_id].sales.push(sale.sales_amount);
                        }
                    }
                });
            }
            for (let i = 0; i < purchaseData.length; i += batchSize) {
                const batch = purchaseData.slice(i, i + batchSize);
                batch.forEach(purchase => {
                    if (purchase.stock_id && purchase.product_name) {
                        if (!products[purchase.stock_id]) {
                            products[purchase.stock_id] = { name: purchase.product_name, sales: [], purchases: [] };
                        }
                        if (purchase.purchase_amount !== undefined) {
                            products[purchase.stock_id].purchases.push(purchase.purchase_amount);
                        }
                    }
                });
            }

            const processedData = {};
            for (const [stockId, data] of Object.entries(products)) {
                const totalSales = data.sales.reduce((sum, val) => sum + (val || 0), 0);
                const dailySales = totalSales / daysActive || 0;
                const stdDev = data.sales.length > 1 ? Math.sqrt(data.sales.reduce((sum, val) => sum + Math.pow(val - dailySales, 2), 0) / data.sales.length) / Math.sqrt(daysActive) : dailySales * 0.2 || 0;
                const totalPurchases = data.purchases.reduce((sum, val) => sum + (val || 0), 0);
                const purchaseDates = purchaseData.filter(p => p.stock_id === stockId).map(p => new Date(p.purchase_date)).sort((a, b) => a - b);
                const leadTime = purchaseDates.length > 1 ? Math.round((purchaseDates[purchaseDates.length - 1] - purchaseDates[0]) / (1000 * 60 * 60 * 24) / (purchaseDates.length - 1)) : 7 || 0;
                const orderCost = totalPurchases / data.purchases.length * 0.1 || 100;
                const unitCost = totalPurchases / totalSales || 200;

                processedData[stockId] = {
                    product_name: data.name,
                    daily_sales: dailySales,
                    lead_time: leadTime,
                    annual_operating_days: annualOperatingDays,
                    order_cost: orderCost,
                    unit_cost: unitCost,
                    std_dev: stdDev,
                    service_reliability: serviceReliability
                };
            }

            return processedData;
        }

        function calculate() {
            const errorDiv = document.getElementById('error');
            const resultsDiv = document.getElementById('results');
            errorDiv.textContent = '';
            resultsDiv.style.display = 'none';
            resultsDiv.innerHTML = '';

            const salesFile = document.getElementById('uploadSales').files[0];
            const purchaseFile = document.getElementById('uploadPurchases').files[0];

            if (!salesFile || !purchaseFile) {
                errorDiv.textContent = 'Please upload both sales and purchase sheets.';
                return;
            }

            Promise.all([processCSVFile(salesFile), processCSVFile(purchaseFile)])
                .then(async ([salesData, purchaseData]) => {
                    const processedData = await preprocessData(salesData, purchaseData);
                    if (!processedData || Object.keys(processedData).length === 0) throw new Error('No valid data to process.');
                    displayResults(processedData);
                })
                .catch(err => {
                    errorDiv.textContent = err.message;
                });
        }

        function displayResults(processedData) {
            const resultsDiv = document.getElementById('results');
            let tableHTML = `
                <table class="result-table">
                    <tr>
                        <th>Stock ID</th>
                        <th>Product Name</th>
                        <th>Safety Stock</th>
                        <th>Reorder Point</th>
                        <th>Optimal Order Size</th>
                    </tr>
            `;

            const charts = [];
            for (const [stockId, data] of Object.entries(processedData)) {
                const ss = safetyStock(data.daily_sales, data.lead_time, data.std_dev, data.service_reliability);
                const rop = reorderPoint(data.daily_sales, data.lead_time, ss);
                const orderQty = optimalOrderSize(data.daily_sales * data.annual_operating_days, data.order_cost, data.unit_cost * 0.25);

                tableHTML += `
                    <tr>
                        <td>${stockId}</td>
                        <td>${data.product_name}</td>
                        <td>${ss.toFixed(2)}</td>
                        <td>${rop.toFixed(2)}</td>
                        <td>${orderQty.toFixed(2)}</td>
                    </tr>
                `;

                const maxValue = Math.max(ss, rop, orderQty);
                charts.push(`
                    <div class="chart">
                        <div class="chart-title">Chart for ${data.product_name}</div>
                        <svg viewBox="0 0 400 360">
                            <line x1="50" y1="320" x2="350" y2="320" stroke="#000" stroke-width="1"/>
                            <line x1="50" y1="40" x2="50" y2="320" stroke="#000" stroke-width="1"/>
                            <g><line x1="100" y1="320" x2="100" y2="${320 - (ss / maxValue * 280)}" stroke="#2b6cb0" stroke-width="2"/><circle cx="100" cy="${320 - (ss / maxValue * 280)}" r="3" fill="#2b6cb0"/><text x="100" y="330" font-size="9" text-anchor="middle">Safety</text></g>
                            <g><line x1="200" y1="320" x2="200" y2="${320 - (rop / maxValue * 280)}" stroke="#e53e3e" stroke-width="2"/><circle cx="200" cy="${320 - (rop / maxValue * 280)}" r="3" fill="#e53e3e"/><text x="200" y="330" font-size="9" text-anchor="middle">Reorder</text></g>
                            <g><line x1="300" y1="320" x2="300" y2="${320 - (orderQty / maxValue * 280)}" stroke="#38a169" stroke-width="2"/><circle cx="300" cy="${320 - (orderQty / maxValue * 280)}" r="3" fill="#38a169"/><text x="300" y="330" font-size="9" text-anchor="middle">Order</text></g>
                            <text x="45" y="150" font-size="9" transform="rotate(-90 45 150)">Units</text>
                        </svg>
                        <legend>Guide: Safety (Blue), Reorder (Red), Order (Green) levels</legend>
                    </div>
                `);
            }

            tableHTML += '</table>';
            tableHTML += '<button onclick="exportToPDF()" style="margin-top: 15px; width: auto;">Export to PDF</button>';
            resultsDiv.innerHTML = tableHTML + '<div class="chart-container">' + charts.join('') + '</div>';
            resultsDiv.style.display = 'block';
        }

        function openModal(tab) {
            document.getElementById('accountModal').style.display = 'flex';
            showTab(tab);
        }

        function closeModal() {
            document.getElementById('accountModal').style.display = 'none';
            document.getElementById('create-tab').style.display = 'none';
            document.getElementById('login-tab').style.display = 'none';
        }

        function showTab(tab) {
            if (tab === 'create') {
                document.getElementById('create-tab').style.display = 'block';
                document.getElementById('login-tab').style.display = 'none';
                document.getElementById('createTabBtn').classList.add('active');
                document.getElementById('loginTabBtn').classList.remove('active');
            } else if (tab === 'login') {
                document.getElementById('create-tab').style.display = 'none';
                document.getElementById('login-tab').style.display = 'block';
                document.getElementById('createTabBtn').classList.remove('active');
                document.getElementById('loginTabBtn').classList.add('active');
            }
        }

        function createAccount() {
            const name = document.getElementById('accountName').value;
            const email = document.getElementById('accountEmail').value;
            const password = document.getElementById('accountPassword').value;

            if (!name || !email || !password) {
                alert('Please fill in all fields.');
                return;
            }

            const data = { name, email, password };
            fetchAccountData(data)
                .then(result => {
                    if (result === 'Success') {
                        isAuthenticated = true;
                        closeModal();
                        alert('Account created successfully!');
                        updateFeedbackForm();
                    } else {
                        alert('Account creation failed. Please try again.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error connecting to server. Check console for details.');
                });
        }

        function logIn() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                alert('Please fill in all fields.');
                return;
            }

            const storedData = { email: 'test@example.com', password: 'password123' };
            if (email === storedData.email && password === storedData.password) {
                isAuthenticated = true;
                closeModal();
                alert('Logged in successfully!');
                updateFeedbackForm();
            } else {
                alert('Invalid email or password.');
            }
        }

        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            if (!jsPDF || !window.html2canvas) {
                alert('Required libraries (jsPDF or html2canvas) failed to load. Check your internet connection or console for errors.');
                console.error('jsPDF or html2canvas not available');
                return;
            }

            if (!isAuthenticated) {
                openModal('login');
                return;
            }

            const resultsDiv = document.getElementById('results');
            if (!resultsDiv) {
                alert('Results section not found. Please generate results first.');
                return;
            }

            const errorDiv = document.getElementById('error');
            errorDiv.textContent = 'Generating PDF...';

            const exportDiv = document.createElement('div');
            exportDiv.innerHTML = resultsDiv.innerHTML.replace('<button onclick="exportToPDF()" style="margin-top: 15px; width: auto;">Export to PDF</button>', '');
            document.body.appendChild(exportDiv);

            html2canvas(exportDiv, { scale: 2, useCORS: true }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 210;
                const pageHeight = 295;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                let heightLeft = imgHeight;
                let position = 10;

                const doc = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });

                try {
                    doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;

                    while (heightLeft > 0) {
                        position += heightLeft - imgHeight + 10;
                        doc.addPage();
                        doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }

                    const pdfDataUri = doc.output('datauristring');
                    const link = document.createElement('a');
                    link.href = pdfDataUri;
                    link.download = 'StockSync_Results.pdf';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    errorDiv.textContent = 'PDF exported successfully!';
                    console.log('PDF save attempted');
                } catch (e) {
                    errorDiv.textContent = 'Error generating PDF: ' + e.message;
                    console.error('PDF generation error:', e);
                }

                document.body.removeChild(exportDiv);
            }).catch(err => {
                errorDiv.textContent = 'Error capturing content: ' + err.message;
                console.error('html2canvas error:', err);
                document.body.removeChild(exportDiv);
            });
        }

        function openFeedbackModal() {
            if (!isAuthenticated) {
                document.getElementById('feedback-auth').style.display = 'block';
            } else {
                document.getElementById('feedback-auth').style.display = 'none';
            }
            document.getElementById('feedbackModal').style.display = 'flex';
            document.getElementById('feedback-form').reset();
        }

        function closeFeedbackModal() {
            document.getElementById('feedbackModal').style.display = 'none';
            document.getElementById('feedback-form').reset();
        }

        function updateFeedbackForm() {
            if (isAuthenticated) {
                document.getElementById('feedback-auth').style.display = 'none';
            } else {
                document.getElementById('feedback-auth').style.display = 'block';
            }
        }

        function submitFeedback() {
            const feature = document.getElementById('feedbackFeature').value;
            const change = document.getElementById('feedbackChange').value;
            let name = '';
            let email = '';

            if (!isAuthenticated) {
                name = document.getElementById('feedbackName').value;
                email = document.getElementById('feedbackEmail').value;
                if (!name || !email || !feature || !change) {
                    alert('Please fill in all fields.');
                    return;
                }
            } else if (!feature || !change) {
                alert('Please select all options.');
                return;
            }

            const data = { feature, change };
            if (!isAuthenticated) {
                data.name = name;
                data.email = email;
            }
            fetchFeedbackData(data)
                .then(result => {
                    if (result === 'Success') {
                        closeFeedbackModal();
                        alert('Feedback submitted successfully!');
                    } else {
                        alert('Feedback submission failed. Please try again.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error connecting to server. Check console for details.');
                });
        }

        function fetchAccountData(data) {
            return fetch('https://script.google.com/macros/s/AKfycbz5JsTGa7rxsxYnIq4VyG-ydw3hHRLASQCPlpGPaS3OraNyPRgKDJhlp2CEdvtj_gNSYA/exec', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => response.text())
            .catch(error => {
                console.error('Fetch error for account data:', error);
                throw error;
            });
        }

        function fetchFeedbackData(data) {
            return fetch('https://script.google.com/macros/s/AKfycbyktDyNutUFoR49Pr7JCYrxHeNRaIa23OZVXpP0CqL2nd8Cm-AA4zSZeuXhxHyoNade/exec', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => response.text())
            .catch(error => {
                console.error('Fetch error for feedback data:', error);
                throw error;
            });
        }
    </script>
</body>
</html>
